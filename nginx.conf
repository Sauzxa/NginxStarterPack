# Number of worker processes to handle requests (usually set to number of CPU cores)
worker_processes 2;

# Event processing configuration
events {
    # Maximum number of simultaneous connections per worker process
    worker_connections 2048;
    # Accept multiple connections at once instead of one at a time
    multi_accept on;
}

# HTTP server configuration block
http {
    # Include MIME types mapping (file extensions to content types)
    include mime.types;
    # Default MIME type for files without a known extension
    default_type application/octet-stream;
    # Enable efficient file transfers using sendfile system call
    sendfile on;
    # Send HTTP response headers in one packet with sendfile
    tcp_nopush on;
    # Disable Nagle's algorithm for real-time applications (reduces latency)
    tcp_nodelay on;
    # How long to keep idle connections alive (in seconds)
    keepalive_timeout 65;
    # Maximum requests per keepalive connection before closing
    keepalive_requests 100;
    # Increase hash bucket size for long server names
    server_names_hash_bucket_size 64;
    
    # Buffer settings - control memory allocation for client requests
    # Buffer size for reading client request body
    client_body_buffer_size 128k;
    # Maximum allowed size of client request body (file uploads, etc.)
    client_max_body_size 10m;
    # Buffer size for reading client request headers
    client_header_buffer_size 1k;
    # Number and size of buffers for large client headers (4 buffers of 8k each)
    large_client_header_buffers 4 8k;
    
    # Gzip compression - reduce bandwidth and improve load times
    # Enable gzip compression
    gzip on;
    # Add Vary: Accept-Encoding header for caching proxies
    gzip_vary on;
    # Minimum file size to compress (bytes) - don't compress tiny files
    gzip_min_length 1000;
    # Compression level (1-9, higher = more compression but more CPU)
    gzip_comp_level 5;
    # File types to compress (text, CSS, JavaScript, JSON, XML)
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/x-javascript;
    # Disable gzip for old IE6 browsers (buggy gzip support)
    gzip_disable "msie6";

    # ========================================
    # HTTP to HTTPS Redirect Server Block
    # ========================================
    # Catches all HTTP (port 80) traffic and redirects to HTTPS (port 443)
    server {
        # Listen on port 80 (HTTP)
        listen 80;
        # Match all domain names used in this configuration
        server_name example.com www.example.com dashboard.example.com api.example.com webapi.example.com;
        # Permanent redirect (301) to HTTPS version of the same URL
        return 301 https://$host$request_uri;
    }

    # ========================================
    # React App #1: Landing Page (Web Server + Reverse Proxy)
    # ========================================
    # Serves static React files AND proxies API calls to Express backend
    server {
        # Listen on port 443 with SSL/TLS encryption
        listen 443 ssl;
        # Domain name(s) this server block responds to
        server_name server1.com www.server2.com;
        
        # SSL certificate files for HTTPS encryption
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        # Only allow secure TLS versions (1.2 and 1.3)
        ssl_protocols TLSv1.2 TLSv1.3;
        # Strong cipher suites, exclude weak/null encryption
        ssl_ciphers HIGH:!aNULL:!MD5;
        
        # Root directory containing built React app files
        root /var/www/landing/dist;
        # Default file to serve
        index index.html;
        
        # REVERSE PROXY: Forward /api/* requests to Express backend on port 8000
        location /api/ {
            # Forward requests to Express app running on localhost:8000
            proxy_pass http://localhost:8000;
            # Use HTTP/1.1 for proxy connection
            proxy_http_version 1.1;
            # Headers needed for WebSocket support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            # Pass original host header to backend
            proxy_set_header Host $host;
            # Pass real client IP address to backend
            proxy_set_header X-Real-IP $remote_addr;
            # Pass chain of proxy IPs
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Tell backend whether request was HTTP or HTTPS
            proxy_set_header X-Forwarded-Proto $scheme;
            # Don't cache upgraded connections (WebSockets)
            proxy_cache_bypass $http_upgrade;
        }
        
        # WEB SERVER: Serve static React files for all other requests
        location / {
            # Try to serve file, then directory, then fallback to index.html
            # This enables React Router (client-side routing) to work
            try_files $uri $uri/ /index.html;
        }
    }

    # ========================================
    # React App #2: Admin Dashboard (Web Server + Reverse Proxy)
    # ========================================
    # Serves static React files AND proxies API calls to Express backend
    server {
        # Listen on port 443 with SSL/TLS encryption
        listen 443 ssl;
        # Subdomain for admin dashboard
        server_name dashboard.example.com;
        
        # SSL certificate files for HTTPS encryption
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        # Only allow secure TLS versions (1.2 and 1.3)
        ssl_protocols TLSv1.2 TLSv1.3;
        # Strong cipher suites, exclude weak/null encryption
        ssl_ciphers HIGH:!aNULL:!MD5;
        
        # Root directory containing built React dashboard files
        root /var/www/dashboard/dist;
        # Default file to serve
        index index.html;
        
        # REVERSE PROXY: Forward /api/* requests to Express backend on port 8000
        location /api/ {
            # Forward requests to Express app running on localhost:8000
            proxy_pass http://localhost:8000;
            # Use HTTP/1.1 for proxy connection
            proxy_http_version 1.1;
            # Headers needed for WebSocket support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            # Pass original host header to backend
            proxy_set_header Host $host;
            # Pass real client IP address to backend
            proxy_set_header X-Real-IP $remote_addr;
            # Pass chain of proxy IPs
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Tell backend whether request was HTTP or HTTPS
            proxy_set_header X-Forwarded-Proto $scheme;
            # Don't cache upgraded connections (WebSockets)
            proxy_cache_bypass $http_upgrade;
        }
        
        # WEB SERVER: Serve static React files for all other requests
        location / {
            # Try to serve file, then directory, then fallback to index.html
            # This enables React Router (client-side routing) to work
            try_files $uri $uri/ /index.html;
        }
    }

    # ========================================
    # Express App #1: API Server on Port 3000 (Pure Reverse Proxy)
    # ========================================
    # Exposes Express backend to external clients (e.g., Flutter mobile app)
    server {
        # Listen on port 443 with SSL/TLS encryption
        listen 443 ssl;
        # Dedicated subdomain for this API
        server_name api.example.com;
        
        # SSL certificate files for HTTPS encryption
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        # Only allow secure TLS versions (1.2 and 1.3)
        ssl_protocols TLSv1.2 TLSv1.3;
        # Strong cipher suites, exclude weak/null encryption
        ssl_ciphers HIGH:!aNULL:!MD5;
        
        # REVERSE PROXY: Forward ALL requests to Express app on port 3000
        location / {
            # Forward to Express app running on localhost:3000
            proxy_pass http://localhost:3000;
            # Use HTTP/1.1 for proxy connection
            proxy_http_version 1.1;
            # Headers needed for WebSocket support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            # Pass original host header to backend
            proxy_set_header Host $host;
            # Pass real client IP address to backend
            proxy_set_header X-Real-IP $remote_addr;
            # Pass chain of proxy IPs
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Tell backend whether request was HTTP or HTTPS
            proxy_set_header X-Forwarded-Proto $scheme;
            # Don't cache upgraded connections (WebSockets)
            proxy_cache_bypass $http_upgrade;
        }
    }

    # ========================================
    # Express App #2: API Server on Port 8000 (Pure Reverse Proxy)
    # ========================================
    # Exposes Express backend to external clients (also used by React apps via /api/)
    server {
        # Listen on port 443 with SSL/TLS encryption
        listen 443 ssl;
        # Dedicated subdomain for this API
        server_name webapi.example.com;
        
        # SSL certificate files for HTTPS encryption
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        # Only allow secure TLS versions (1.2 and 1.3)
        ssl_protocols TLSv1.2 TLSv1.3;
        # Strong cipher suites, exclude weak/null encryption
        ssl_ciphers HIGH:!aNULL:!MD5;
        
        # REVERSE PROXY: Forward ALL requests to Express app on port 8000
        location / {
            # Forward to Express app running on localhost:8000
            proxy_pass http://localhost:8000;
            # Use HTTP/1.1 for proxy connection
            proxy_http_version 1.1;
            # Headers needed for WebSocket support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            # Pass original host header to backend
            proxy_set_header Host $host;
            # Pass real client IP address to backend
            proxy_set_header X-Real-IP $remote_addr;
            # Pass chain of proxy IPs
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Tell backend whether request was HTTP or HTTPS
            proxy_set_header X-Forwarded-Proto $scheme;
            # Don't cache upgraded connections (WebSockets)
            proxy_cache_bypass $http_upgrade;
        }
    }
}